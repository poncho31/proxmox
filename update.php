<?php
#!/usr/bin/env php

/**
 * Script de mise √† jour Proxmox LXC - Serveur Web PHP
 * Acc√®s: https://192.168.0.51/
 */

set_time_limit(60);

// ========================================
// TABLEAU DES OP√âRATIONS
// ========================================

$operations = [
    'initial_check' => [
        'description' => 'Diagnostic initial du syst√®me',
        'command' => 'initialSystemCheck',
        'success_message' => 'Diagnostic initial termin√©',
        'error_message' => 'Probl√®me diagnostic initial'
    ],
    'system_update' => [
        'description' => 'Mise √† jour des paquets syst√®me',
        'command' => 'apt update && apt upgrade -y',
        'success_message' => 'Syst√®me mis √† jour avec succ√®s',
        'error_message' => 'Erreur lors de la mise √† jour syst√®me'
    ],
    'install_dependencies' => [
        'description' => 'Installation des d√©pendances requises',
        'command' => 'apt install -y nginx php8.2-fpm php8.2-common php8.2-mysql php8.2-xml php8.2-xmlrpc php8.2-curl php8.2-gd php8.2-imagick php8.2-cli php8.2-dev php8.2-imap php8.2-mbstring php8.2-opcache php8.2-soap php8.2-zip openssl curl',
        'success_message' => 'D√©pendances Nginx/PHP install√©es avec succ√®s',
        'error_message' => 'Erreur lors de l\'installation des d√©pendances'
    ],
    'configure_ip' => [
        'description' => 'Configuration de l\'IP 192.168.0.51',
        'command' => 'configureProxmoxIP',
        'success_message' => 'IP 192.168.0.51 configur√©e',
        'error_message' => 'Erreur configuration IP'
    ],

    'configure_nginx' => [
        'description' => 'Configuration Nginx HTTP pour 192.168.0.51',
        'command' => 'configureNginx',
        'success_message' => 'Configuration Nginx HTTP appliqu√©e',
        'error_message' => 'Erreur configuration Nginx'
    ],
    'fix_permissions' => [
        'description' => 'Correction des permissions',
        'command' => 'chown -R www-data:www-data /var/www/html && chmod -R 755 /var/www/html',
        'success_message' => 'Permissions corrig√©es',
        'error_message' => 'Erreur correction permissions'
    ],
    'restart_php' => [
        'description' => 'Red√©marrage PHP-FPM',
        'command' => 'systemctl restart php8.2-fpm && systemctl enable php8.2-fpm',
        'success_message' => 'PHP-FPM red√©marr√© et activ√©',
        'error_message' => 'Erreur red√©marrage PHP-FPM'
    ],
    'restart_nginx' => [
        'description' => 'Red√©marrage Nginx',
        'command' => 'systemctl restart nginx && systemctl enable nginx',
        'success_message' => 'Nginx red√©marr√© et activ√©',
        'error_message' => 'Erreur red√©marrage Nginx'
    ],
    'test_connectivity' => [
        'description' => 'Test de connectivit√© finale',
        'command' => 'testConnectivity',
        'success_message' => 'Tests de connectivit√© r√©ussis',
        'error_message' => 'Probl√®me de connectivit√© d√©tect√©'
    ],

];

// ========================================
// FONCTIONS UTILITAIRES
// ========================================

function execCommand($command) {
    $output = [];
    $returnCode = 0;
    exec($command . " 2>&1", $output, $returnCode);
    return [
        'success' => $returnCode === 0,
        'output' => implode("\n", $output),
        'code' => $returnCode
    ];
}

function printStatus($message, $success = true) {
    $color = $success ? "\033[32m" : "\033[31m";
    $reset = "\033[0m";
    echo $color . $message . $reset . "\n";
}

function printInfo($message) {
    echo "\033[34m" . $message . "\033[0m\n";
}

// ========================================
// EX√âCUTION PRINCIPALE
// ========================================

echo "üöÄ MISE √Ä JOUR SERVEUR PROXMOX LXC\n";
echo "===================================\n";
echo "üåê Configuration pour: http://192.168.0.51/\n\n";

$successful = 0;
$failed = 0;

$stepNum = 0;
foreach ($operations as $operationKey => $operation) {
    $stepNum++;
    printInfo("[$stepNum/" . count($operations) . "] [$operationKey] " . $operation['description'] . "...");
    
    // Ex√©cuter la commande
    if (function_exists($operation['command'])) {
        $result = call_user_func($operation['command']);
    } else {
        $result = execCommand($operation['command']);
    }
    
    if ($result['success']) {
        printStatus("‚úÖ " . $operation['success_message']);
        $successful++;
        
        // Afficher sortie si pertinente
        if (!empty($result['output']) && 
            !in_array(trim($result['output']), ['', 'OK', 'Done'])) {
            echo "   " . trim($result['output']) . "\n";
        }
    } else {
        printStatus("‚ùå " . $operation['error_message'], false);
        $failed++;
        
        if (!empty($result['output'])) {
            echo "   Erreur: " . trim($result['output']) . "\n";
        }
        
        // Optionnel: arr√™ter en cas d'erreur critique
        if (in_array($operationKey, ['system_update', 'install_dependencies'])) {
            printStatus("‚ö†Ô∏è Erreur critique d√©tect√©e, arr√™t du processus", false);
            break;
        }
    }
    
    echo "\n";
}

// ========================================
// R√âSUM√â FINAL
// ========================================

echo "===================================\n";
echo "üìä R√âSUM√â: $successful r√©ussies / $failed √©chou√©es\n";
echo "===================================\n";

if ($failed === 0) {
    printStatus("üéâ MISE √Ä JOUR TERMIN√âE AVEC SUCC√àS !");
    echo "\nüåê Serveur accessible sur: http://192.168.0.51/\n";
    echo "üìù Todo List sur: http://192.168.0.51:8080/\n";
    echo "\nüí° Commandes utiles:\n";
    echo "   - systemctl status nginx php8.2-fpm\n";
    echo "   - curl http://192.168.0.51/\n";
    echo "   - nginx -t (test config)\n";
} else {
    printStatus("‚ö†Ô∏è MISE √Ä JOUR PARTIELLEMENT R√âUSSIE", false);
    echo "\nüîß V√©rifiez les erreurs et relancez si n√©cessaire\n";
}

exit($failed > 0 ? 1 : 0);

// ========================================
// FONCTIONS COMPLEXES
// ========================================

function initialSystemCheck() {
    echo "=== DIAGNOSTIC INITIAL SYST√àME ===\n";
    
    // V√©rifier l'OS
    $os = execCommand('cat /etc/os-release | grep PRETTY_NAME');
    echo "Syst√®me: " . trim(str_replace('PRETTY_NAME=', '', str_replace('"', '', $os['output']))) . "\n";
    
    // Afficher TOUTES les IPs du serveur
    $allIPs = execCommand('hostname -I');
    echo "IPs du serveur: " . trim($allIPs['output']) . "\n";
    
    // D√©tecter l'IP principale dans le r√©seau 192.168.0.x
    $mainIP = execCommand('hostname -I | tr " " "\n" | grep "^192.168.0\." | head -1');
    $detectedIP = trim($mainIP['output']);
    if (!empty($detectedIP)) {
        echo "IP principale d√©tect√©e: $detectedIP\n";
        if ($detectedIP !== '192.168.0.51') {
            echo "‚ö†Ô∏è ATTENTION: IP d√©tect√©e ($detectedIP) ‚â† IP configur√©e (192.168.0.51)\n";
        }
    }
    
    // V√©rifier les services
    $nginx = execCommand('systemctl is-active nginx');
    $php = execCommand('systemctl is-active php8.2-fpm');
    echo "Nginx: " . ($nginx['success'] ? "‚úÖ ACTIF" : "‚ùå INACTIF") . "\n";
    echo "PHP-FPM: " . ($php['success'] ? "‚úÖ ACTIF" : "‚ùå INACTIF") . "\n";
    
    // V√©rifier la configuration Nginx actuelle
    $nginxTest = execCommand('nginx -t');
    echo "Config Nginx: " . ($nginxTest['success'] ? "‚úÖ VALIDE" : "‚ùå ERREURS") . "\n";
    
    if (!$nginxTest['success']) {
        echo "Erreurs Nginx actuelles:\n" . $nginxTest['output'] . "\n";
    }
    
    // V√©rifier les logs d'erreur Nginx r√©cents
    $nginxErrors = execCommand('tail -5 /var/log/nginx/error.log 2>/dev/null');
    if (!empty($nginxErrors['output'])) {
        echo "Erreurs Nginx r√©centes:\n" . $nginxErrors['output'] . "\n";
    }
    
    // V√©rifier les interfaces r√©seau
    $interfaces = execCommand('ip addr show | grep "inet " | grep -v "127.0.0.1"');
    echo "Interfaces r√©seau:\n" . trim($interfaces['output']) . "\n";
    
    // V√©rifier si 192.168.0.51 est d√©j√† configur√©e
    $checkIP = execCommand('ip addr show | grep "192.168.0.51"');
    echo "IP 192.168.0.51: " . (!empty($checkIP['output']) ? "‚úÖ D√âJ√Ä CONFIGUR√âE" : "‚ùå √Ä CONFIGURER") . "\n";
    
    // V√©rifier les ports en √©coute
    $ports = execCommand('ss -tlnp | grep ":80\|:8080"');
    echo "Ports 80/8080 en √©coute:\n" . ($ports['output'] ?: "Aucun port en √©coute") . "\n";
    
    // V√©rifier les fichiers web critiques
    $webDir = '/var/www/html/php/public';
    $files = ['proxmox_main_web_server.php', 'index.php', 'todo_list.php'];
    echo "Fichiers web dans $webDir:\n";
    foreach ($files as $file) {
        $exists = file_exists("$webDir/$file");
        echo "  - $file: " . ($exists ? "‚úÖ EXISTE" : "‚ùå MANQUANT") . "\n";
    }
    
    // V√©rifier si le fichier de config existe
    $configFile = '/var/www/html/php/config/nginx.conf';
    echo "Fichier config nginx.conf: " . (file_exists($configFile) ? "‚úÖ EXISTE" : "‚ùå MANQUANT") . "\n";
    
    // V√©rifier les permissions du r√©pertoire web
    $webPerms = execCommand("ls -la $webDir");
    echo "Permissions $webDir: " . ($webPerms['success'] ? "‚úÖ ACCESSIBLE" : "‚ùå PROBL√àME") . "\n";
    
    return ['success' => true, 'output' => 'Diagnostic syst√®me effectu√©'];
}

function configureProxmoxIP() {
    echo "=== CONFIGURATION IP 192.168.0.51 ===\n";
    
    // Afficher les interfaces actuelles
    $interfaces = execCommand('ip addr show | grep "inet " | grep -v "127.0.0.1"');
    echo "Interfaces actuelles:\n" . $interfaces['output'] . "\n";
    
    // V√©rifier si l'IP existe d√©j√†
    $checkIP = execCommand('ip addr show | grep "192.168.0.51"');
    if (!empty($checkIP['output'])) {
        echo "IP 192.168.0.51 d√©j√† configur√©e\n";
        return ['success' => true, 'output' => 'IP 192.168.0.51 d√©j√† configur√©e'];
    }
    
    // D√©tecter l'interface r√©seau principale
    $interface = execCommand('ip route | grep default | awk \'{print $5}\' | head -1');
    $iface = trim($interface['output']);
    
    if (empty($iface)) {
        // Essayer de d√©tecter eth0 ou la premi√®re interface
        $firstIface = execCommand('ip link show | grep "^[0-9]" | grep -v "lo:" | head -1 | awk -F": " \'{print $2}\'');
        $iface = trim($firstIface['output']);
        if (empty($iface)) {
            $iface = 'eth0'; // D√©faut
        }
    }
    
    echo "Interface d√©tect√©e: $iface\n";
    
    // Tentatives d'ajout de l'IP avec diff√©rentes m√©thodes
    $methods = [
        "ip addr add 192.168.0.51/24 dev $iface",
        "ip addr add 192.168.0.51/32 dev $iface",
        "ifconfig $iface:1 192.168.0.51 netmask 255.255.255.0"
    ];
    
    foreach ($methods as $method) {
        echo "Essai: $method\n";
        $result = execCommand($method);
        
        // V√©rifier si l'ajout a r√©ussi
        $verify = execCommand('ip addr show | grep "192.168.0.51"');
        if (!empty($verify['output'])) {
            echo "‚úÖ IP 192.168.0.51 ajout√©e avec succ√®s\n";
            return ['success' => true, 'output' => "IP 192.168.0.51 ajout√©e sur $iface"];
        }
        
        if (!$result['success'] && !strpos($result['output'], 'File exists')) {
            echo "√âchec: " . $result['output'] . "\n";
        }
    }
    
    // Si toutes les m√©thodes √©chouent, donner des instructions
    echo "‚ö†Ô∏è Impossible d'ajouter automatiquement l'IP 192.168.0.51\n";
    echo "üìù Instructions manuelles:\n";
    echo "1. Dans Proxmox Web UI > Container > Network\n";
    echo "2. Ajouter une IP statique: 192.168.0.51/24\n";
    echo "3. Ou dans le conteneur: ip addr add 192.168.0.51/24 dev $iface\n";
    
    return ['success' => false, 'output' => 'Configuration manuelle requise pour IP 192.168.0.51'];
}



function configureNginx() {
    echo "=== CONFIGURATION NGINX HTTP ===\n";
    
    // D√©tecter l'IP r√©elle du serveur
    $serverIP = trim(execCommand('hostname -I | tr " " "\n" | grep "^192.168.0\." | head -1')['output']);
    if (!empty($serverIP)) {
        echo "IP serveur d√©tect√©e: $serverIP\n";
    }
    
    // Localiser le fichier de config du projet
    $projectConfigPath = '/var/www/html/php/config/nginx.conf';
    $systemConfigPath = '/etc/nginx/nginx.conf';
    
    // V√©rifier si le fichier de config du projet existe
    if (!file_exists($projectConfigPath)) {
        // Si pas trouv√©, chercher dans le r√©pertoire actuel
        $currentDir = getcwd();
        $alternativeConfig = "$currentDir/config/nginx.conf";
        if (file_exists($alternativeConfig)) {
            $projectConfigPath = $alternativeConfig;
            echo "Config trouv√©e dans: $alternativeConfig\n";
        } else {
            return ['success' => false, 'output' => "Fichier config introuvable: $projectConfigPath"];
        }
    }
    
    echo "Fichier config trouv√©: ‚úÖ\n";
    
    // V√©rifier le contenu de la config pour l'IP
    $configContent = file_get_contents($projectConfigPath);
    if (!empty($serverIP) && $serverIP !== '192.168.0.51' && strpos($configContent, '192.168.0.51') !== false) {
        echo "‚ö†Ô∏è ATTENTION: Config utilise 192.168.0.51 mais serveur utilise $serverIP\n";
        echo "üí° Adaptation automatique de la configuration...\n";
        
        // Cr√©er une version adapt√©e temporairement
        $adaptedConfig = str_replace('192.168.0.51', $serverIP, $configContent);
        $tempConfigPath = '/tmp/nginx.conf.adapted';
        file_put_contents($tempConfigPath, $adaptedConfig);
        $projectConfigPath = $tempConfigPath;
        echo "Config adapt√©e pour IP $serverIP: ‚úÖ\n";
    }
    
    // Sauvegarder la config syst√®me actuelle
    $backup = execCommand("cp $systemConfigPath $systemConfigPath.backup");
    echo "Sauvegarde config syst√®me: " . ($backup['success'] ? "‚úÖ" : "‚ùå") . "\n";
    
    // Copier la config du projet vers le syst√®me
    $copy = execCommand("cp $projectConfigPath $systemConfigPath");
    if (!$copy['success']) {
        return ['success' => false, 'output' => "Impossible de copier la config: " . $copy['output']];
    }
    echo "Config copi√©e: ‚úÖ\n";
    
    // Tester la configuration
    $test = execCommand('nginx -t');
    echo "Test syntaxe: " . ($test['success'] ? "‚úÖ" : "‚ùå") . "\n";
    
    if (!$test['success']) {
        echo "Erreur syntaxe:\n" . $test['output'] . "\n";
        // Restaurer la sauvegarde
        execCommand("cp $systemConfigPath.backup $systemConfigPath");
        return ['success' => false, 'output' => 'Configuration Nginx invalide: ' . $test['output']];
    }
    
    // V√©rifier/cr√©er les r√©pertoires web
    $webDir = '/var/www/html/php/public';
    $checkDir = execCommand("ls -la $webDir");
    echo "R√©pertoire web: " . ($checkDir['success'] ? "‚úÖ" : "‚ùå") . "\n";
    
    if (!$checkDir['success']) {
        echo "Cr√©ation r√©pertoire web...\n";
        execCommand("mkdir -p $webDir");
    }
    
    // Cr√©er/v√©rifier les fichiers web essentiels
    $filesToCreate = [
        'index.php' => '<?php
$serverIP = $_SERVER["SERVER_ADDR"] ?? "N/A";
$hostHeader = $_SERVER["HTTP_HOST"] ?? "N/A";
$allIPs = shell_exec("hostname -I") ?: "N/A";

echo "<h1>üöÄ Serveur Proxmox HTTP</h1>";
echo "<p>‚úÖ Serveur fonctionnel</p>";
echo "<p>üåê Host: " . htmlspecialchars($hostHeader) . "</p>";
echo "<p>üìç IP Serveur: " . htmlspecialchars($serverIP) . "</p>";
echo "<p>üìã Toutes les IPs: " . htmlspecialchars(trim($allIPs)) . "</p>";
echo "<p>üïê Heure: " . date("Y-m-d H:i:s") . "</p>";
echo "<hr>";
echo "<h3>ÔøΩ Fichiers disponibles</h3>";
echo "<ul>";
if (file_exists("proxmox_main_web_server.php")) echo "<li><a href=\"proxmox_main_web_server.php\">Serveur Principal</a></li>";
if (file_exists("todo_list.php")) echo "<li><a href=\":8080/todo_list.php\">Todo List (port 8080)</a></li>";
echo "<li><a href=\"?phpinfo=1\">PHPInfo</a></li>";
echo "</ul>";
if (isset($_GET["phpinfo"])) { echo "<hr>"; phpinfo(); }
?>',
        'proxmox_main_web_server.php' => '<?php
$serverIP = $_SERVER["SERVER_ADDR"] ?? "N/A";
$allIPs = shell_exec("hostname -I") ?: "N/A";

echo "<h1>üåê Proxmox Main Web Server</h1>";
echo "<p>‚úÖ Serveur principal fonctionnel</p>";
echo "<p>üìç IP: " . htmlspecialchars($serverIP) . "</p>";
echo "<p>üìã Toutes les IPs: " . htmlspecialchars(trim($allIPs)) . "</p>";
echo "<p>üåç Host: " . htmlspecialchars($_SERVER["HTTP_HOST"] ?? "N/A") . "</p>";
echo "<p>üïê Heure: " . date("Y-m-d H:i:s") . "</p>";
echo "<hr>";
echo "<p><a href=\"index.php\">‚Üê Retour √† l\'accueil</a></p>";
?>',
        'todo_list.php' => '<?php
echo "<h1>üìã Todo List Proxmox</h1>";
echo "<p>‚úÖ Todo List fonctionnelle sur port 8080</p>";
echo "<p>üìç IP: " . ($_SERVER["SERVER_ADDR"] ?? "N/A") . "</p>";
echo "<p>üïê Heure: " . date("Y-m-d H:i:s") . "</p>";
echo "<hr>";
echo "<h3>üìù T√¢ches exemple</h3>";
echo "<ul>";
echo "<li>‚úÖ Configuration serveur web</li>";
echo "<li>‚úÖ Installation PHP/Nginx</li>";
echo "<li>‚è≥ Tests de connectivit√©</li>";
echo "</ul>";
echo "<hr>";
echo "<p><a href=\":80/\">‚Üê Retour au serveur principal</a></p>";
?>'
    ];
    
    foreach ($filesToCreate as $filename => $content) {
        $filePath = "$webDir/$filename";
        if (!file_exists($filePath)) {
            file_put_contents($filePath, $content);
            echo "Fichier $filename cr√©√©: ‚úÖ\n";
        } else {
            echo "Fichier $filename existe: ‚úÖ\n";
        }
    }
    
    // V√©rifier les permissions
    execCommand("chown -R www-data:www-data $webDir");
    execCommand("chmod -R 755 $webDir");
    
    return ['success' => true, 'output' => "Configuration Nginx HTTP appliqu√©e (IP: $serverIP)"];
}

function testConnectivity() {
    echo "=== TESTS DE CONNECTIVIT√â FINAUX ===\n";
    
    // D√©tecter l'IP r√©elle du serveur
    $allServerIPs = trim(execCommand('hostname -I')['output']);
    $mainServerIP = trim(execCommand('hostname -I | tr " " "\n" | grep "^192.168.0\." | head -1')['output']);
    echo "üåê Toutes les IPs serveur: $allServerIPs\n";
    if (!empty($mainServerIP)) {
        echo "üìç IP principale d√©tect√©e: $mainServerIP\n";
    }
    
    // V√©rifier l'√©tat des services
    $nginxStatus = execCommand('systemctl is-active nginx');
    $phpStatus = execCommand('systemctl is-active php8.2-fpm');
    echo "√âtat services:\n";
    echo "  - Nginx: " . ($nginxStatus['success'] ? "‚úÖ ACTIF" : "‚ùå INACTIF") . "\n";
    echo "  - PHP-FPM: " . ($phpStatus['success'] ? "‚úÖ ACTIF" : "‚ùå INACTIF") . "\n";
    
    // V√©rifier la config Nginx
    $nginxTest = execCommand('nginx -t');
    echo "  - Config Nginx: " . ($nginxTest['success'] ? "‚úÖ VALIDE" : "‚ùå ERREURS") . "\n";
    
    if (!$nginxTest['success']) {
        echo "    Erreurs: " . trim($nginxTest['output']) . "\n";
    }
    
    // V√©rifier les ports en √©coute
    $ports80 = execCommand('ss -tlnp | grep ":80 "');
    $ports8080 = execCommand('ss -tlnp | grep ":8080 "');
    echo "Ports en √©coute:\n";
    echo "  - Port 80: " . (!empty($ports80['output']) ? "‚úÖ OUVERT" : "‚ùå FERM√â") . "\n";
    echo "  - Port 8080: " . (!empty($ports8080['output']) ? "‚úÖ OUVERT" : "‚ùå FERM√â") . "\n";
    
    // Afficher quels processus √©coutent
    if (!empty($ports80['output'])) {
        echo "    Port 80: " . trim(explode("\n", $ports80['output'])[0]) . "\n";
    }
    if (!empty($ports8080['output'])) {
        echo "    Port 8080: " . trim(explode("\n", $ports8080['output'])[0]) . "\n";
    }
    
    // V√©rifier si l'IP est configur√©e (soit 192.168.0.51 soit l'IP d√©tect√©e)
    $checkIP51 = execCommand('ip addr show | grep "192.168.0.51"');
    $checkMainIP = !empty($mainServerIP) ? execCommand("ip addr show | grep \"$mainServerIP\"") : ['output' => ''];
    
    echo "Configuration IP:\n";
    echo "  - IP 192.168.0.51: " . (!empty($checkIP51['output']) ? "‚úÖ CONFIGUR√âE" : "‚ùå NON CONFIGUR√âE") . "\n";
    
    if (!empty($mainServerIP) && $mainServerIP !== '192.168.0.51') {
        echo "  - IP $mainServerIP: " . (!empty($checkMainIP['output']) ? "‚úÖ CONFIGUR√âE" : "‚ùå NON CONFIGUR√âE") . "\n";
    }
    
    // Tests de connectivit√©
    echo "Tests HTTP:\n";
    
    // Test localhost
    $httpLocal = execCommand('curl -I -s http://localhost --connect-timeout 3');
    $localOK = strpos($httpLocal['output'], '200 OK') !== false || strpos($httpLocal['output'], '301') !== false;
    echo "  - http://localhost: " . ($localOK ? "‚úÖ OK" : "‚ùå KO") . "\n";
    
    if (!$localOK && !empty($httpLocal['output'])) {
        $firstLine = trim(explode("\n", $httpLocal['output'])[0]);
        echo "    R√©ponse: $firstLine\n";
    }
    
    // Test de l'IP d√©tect√©e si diff√©rente de 192.168.0.51
    $ipOK = false;
    if (!empty($mainServerIP)) {
        $httpIP = execCommand("curl -I -s http://$mainServerIP --connect-timeout 3");
        $ipOK = strpos($httpIP['output'], '200 OK') !== false || strpos($httpIP['output'], '301') !== false;
        echo "  - http://$mainServerIP: " . ($ipOK ? "‚úÖ OK" : "‚ùå KO") . "\n";
        
        if (!$ipOK && !empty($httpIP['output'])) {
            $firstLine = trim(explode("\n", $httpIP['output'])[0]);
            echo "    R√©ponse: $firstLine\n";
        }
    }
    
    // Test 192.168.0.51 seulement si diff√©rente de l'IP d√©tect√©e
    if (!empty($checkIP51['output']) && $mainServerIP !== '192.168.0.51') {
        $http51 = execCommand('curl -I -s http://192.168.0.51 --connect-timeout 3');
        $ok51 = strpos($http51['output'], '200 OK') !== false || strpos($http51['output'], '301') !== false;
        echo "  - http://192.168.0.51: " . ($ok51 ? "‚úÖ OK" : "‚ùå KO") . "\n";
        
        if (!$ok51 && !empty($http51['output'])) {
            $firstLine = trim(explode("\n", $http51['output'])[0]);
            echo "    R√©ponse: $firstLine\n";
        }
        $ipOK = $ipOK || $ok51;
    }
    
    // V√©rifier les fichiers web essentiels
    $webDir = '/var/www/html/php/public';
    $files = ['index.php', 'proxmox_main_web_server.php', 'todo_list.php'];
    echo "Fichiers web:\n";
    foreach ($files as $file) {
        $exists = file_exists("$webDir/$file");
        echo "  - $file: " . ($exists ? "‚úÖ EXISTE" : "‚ùå MANQUANT") . "\n";
    }
    
    // V√©rifier les logs d'erreur r√©cents
    $recentErrors = execCommand('tail -3 /var/log/nginx/error.log 2>/dev/null | grep -v "notice"');
    if (!empty($recentErrors['output'])) {
        echo "‚ö†Ô∏è Erreurs Nginx r√©centes:\n";
        $lines = explode("\n", trim($recentErrors['output']));
        foreach ($lines as $line) {
            if (!empty(trim($line))) {
                echo "    " . trim($line) . "\n";
            }
        }
    }
    
    $allOK = $nginxStatus['success'] && $phpStatus['success'] && ($localOK || $ipOK);
    
    if ($allOK) {
        echo "\nüéâ Serveur accessible sur:\n";
        echo "   - http://localhost/ (local)\n";
        if (!empty($mainServerIP)) {
            echo "   - http://$mainServerIP/ (r√©seau)\n";
            echo "   - http://$mainServerIP:8080/ (todo list)\n";
        }
        if (!empty($checkIP51['output']) && $mainServerIP !== '192.168.0.51') {
            echo "   - http://192.168.0.51/ (IP configur√©e)\n";
            echo "   - http://192.168.0.51:8080/ (todo list)\n";
        }
    } else {
        echo "\n‚ö†Ô∏è Probl√®mes d√©tect√©s - v√©rifiez la configuration\n";
    }
    
    return [
        'success' => $allOK,
        'output' => "Services: " . ($nginxStatus['success'] && $phpStatus['success'] ? "‚úÖ" : "‚ùå") . 
                   ", HTTP: " . (($localOK || $ipOK) ? "‚úÖ" : "‚ùå") . 
                   ", IP: " . (!empty($mainServerIP) ? $mainServerIP : "aucune")
    ];
}



?>
